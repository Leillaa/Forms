<form id="signup-form" class="signup-form">
    {% csrf_token %}
    {% for field in form %}
      <div class="form-group row my-3">
        <label for="{{ field.id_for_label }}">
          {{ field.label }}
          {% if field.field.required %}
            <span class="required text-danger">*</span>
          {% endif %}
        </label>
  {{ field }}
        {% if field.help_text %}
          <small id="{{ field.id_for_label }}-help" class="form-text text-muted">
            {{ field.help_text|safe }}
          </small>
        {% endif %}
      </div>
    {% endfor %}

  <div class="col-md-6 offset-md-4">
    <button type="submit" class="btn btn-primary">
    Зарегистрироваться
    </button>
  </div>
</form>
<div id="signup-message" style="margin-top:10px;"></div>

<script>
document.getElementById('signup-form').addEventListener('submit', function(e) {
  e.preventDefault();
  const form = e.target;
  const formData = new FormData(form);
  fetch('/users/ajax_signup/', {
    method: 'POST',
    headers: {
      'X-CSRFToken': form.querySelector('[name=csrfmiddlewaretoken]').value
    },
    body: formData
  })
  .then(response => response.json())
  .then(data => {
    const msgDiv = document.getElementById('signup-message');
    if (data.success) {
      msgDiv.innerHTML = '<span style="color:green">' + data.message + '</span>';
      // Автоматический вход
      fetch('/users/login/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
          'X-CSRFToken': form.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: 'username=' + encodeURIComponent(form.querySelector('[name=username]').value) + '&password=' + encodeURIComponent(form.querySelector('[name=password1]').value)
      })
      .then(resp => {
        if (resp.ok) {
          window.location.href = '/users/profile/';
        } else {
          msgDiv.innerHTML += '<br><span style="color:red">Ошибка входа после регистрации.</span>';
        }
      });
    } else {
      if (data.errors) {
        let errors = '';
        Object.values(data.errors).forEach(arr => {
          arr.forEach(e => { errors += e.message + '<br>'; });
        });
        msgDiv.innerHTML = '<span style="color:red">' + errors + '</span>';
      } else {
        msgDiv.innerHTML = '<span style="color:red">' + (data.message || 'Ошибка регистрации') + '</span>';
      }
    }
  });
});
</script>
